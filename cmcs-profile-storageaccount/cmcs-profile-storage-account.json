{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "storageAccountName": {
            "type": "string",
            "maxLength": 15
        },
        "fileShareName": {
            "type": "string",
            "minLength": 3,
            "maxLength": 63
        },
        "location": {
            "type": "string"
        },
        "vnetrg": {
            "type": "string"
        },
        "vnet": {
            "type": "string"
        },
        "subnet": {
            "type": "string"
        },
        "quota": {
            "type": "int"
        },
        "tags": {
            "type": "object",
            "defaultValue": {}
        },
        "backuprg": {
            "type": "string",
            "defaultValue": null
        },
        "backuppolicyname": {
            "type": "string",
            "defaultValue": null
        },
        "backupvaultname": {
            "type": "string",
            "defaultValue": null
        }
    },
    "resources": [
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-04-01",
            "name": "[parameters('storageAccountName')]",
            "location": "[parameters('location')]",
            "kind": "FileStorage",
            "sku": {
                "name": "Premium_LRS"
            },
            "properties": {
                "networkAcls": {
                    "bypass": "AzureServices",
                    "defaultAction": "Deny",
                    "virtualNetworkRules": [
                        {
                            "id": "[concat(subscription().id,'/resourceGroups/',parameters('vnetrg'),'/providers/Microsoft.Network/virtualNetworks/',parameters('vnet'),'/subnets/',parameters('subnet'))]"
                        }
                    ]
                    
                    
                }
            },
            "tags": "[parameters('tags')]"
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
            "apiVersion": "2021-04-01",
            "name": "[concat(parameters('storageAccountName'), '/default/', parameters('fileShareName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            ],
            "properties": {
                "shareQuota": "[parameters('quota')]"
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "BackupDeployment",
            "resourceGroup": "[parameters('backuprg')]",
            "condition": "[and(not(equals(null(),parameters('backuprg'))),not(equals(null(),parameters('backupvaultname'))),not(equals(null(),parameters('backuppolicyname'))))]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",            
                "parameters": {
                "filesharename": {
                    "value": "[parameters('filesharename')]"
                },
                "storagerg": {
                    "value": "[resourceGroup().name]"
                },
                "storageAccountName": {
                    "value":"[parameters('storageAccountName')]"
                },
                "vaultName": {
                    "value": "[parameters('backupvaultName')]"
                },
                "policyName": {
                    "value": "[parameters('backuppolicyName')]"
                }
            },
            
                "template": {            
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "vaultName": {
                            "type": "String"
                        },
                        "policyName": {
                            "type": "String"
                        },
                        "filesharename":{
                            "type": "string"
                        },
                        "storageAccountName": {
                            "type": "string"                        
                        },
                        "storagerg":{
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers",
                            "apiVersion": "2020-02-02",
                            "name": "[concat(parameters('vaultName'), '/Azure/storagecontainer;Storage;', parameters('storagerg'), ';', parameters('StorageAccountName'))]",
                            "properties": {
                              "backupManagementType": "AzureStorage",
                              "containerType": "StorageContainer",
                              "sourceResourceId": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',parameters('storagerg'),'/providers/Microsoft.Storage/storageAccounts/',parameters('StorageAccountName'))]"
                            }
                        },
                        {
                            "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                            "apiVersion": "2020-02-02",
                            "name": "[concat(parameters('vaultName'), '/Azure/storagecontainer;Storage;', parameters('storagerg'), ';', parameters('StorageAccountName'), '/AzureFileShare;', parameters('FileShareName'))]",
                            "dependsOn": [
                              "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', parameters('vaultName'), 'Azure', concat('storagecontainer;Storage;', parameters('storagerg'), ';', parameters('StorageAccountName')))]"
                            ],
                            "properties": {
                              "protectedItemType": "AzureFileShareProtectedItem",
                              "sourceResourceId": "[resourceId(parameters('storagerg'), 'Microsoft.Storage/storageAccounts', parameters('StorageAccountName'))]",
                              "policyId": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('vaultName'), parameters('policyName'))]",
                              "isInlineInquiry": true
                            }
                        }
                    ]
                }
            }
        }
    ]
}